{"ts":1354147355657,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"function toHost(url) {\n        var host = new RegExp('(https{0,1}://.*?)/.*').exec(url);\n        if (host == null)\n                host = url;\n        else\n                host = host[1];\n        return host;\n}\n\n/* Server URLS for the various languages */\n//baseServerUrlPostfix = '.service.afterthedeadline.com';\nbaseServerUrlPostfix = '.afterthedeadline-pressgangccms.rhcloud.com';\nbaseServerUrlPrefix = 'https://';\n\nfrenchServerUrl = baseServerUrlPrefix + 'fr' + baseServerUrlPostfix;\ngermanServerUrl = baseServerUrlPrefix + 'de' + baseServerUrlPostfix;\nportugueseServerUrl = baseServerUrlPrefix + 'pt' + baseServerUrlPostfix;\nspanishServerUrl = baseServerUrlPrefix + 'es' + baseServerUrlPostfix;\nenglishServerUrl = baseServerUrlPrefix + 'en' + baseServerUrlPostfix;\n\n\n/* define default values for Language and the keyboard shortcut */\nif (localStorage['language'] == undefined)\n\tlocalStorage['language'] = 'English';\nif (localStorage['shortcut'] == undefined)\n\tlocalStorage['shortcut'] = 'true,false,true,false,83,0';\nif (localStorage['auto'] == undefined)\n\tlocalStorage['auto'] = 'false';\nif (localStorage['button'] == undefined)\n\tlocalStorage['button'] = 'true';\nif (localStorage['message'] == undefined)\n\tlocalStorage['message'] = 'true';\n\n/* always disable auto-proofread feature in older versions of Chrome */\nif (chrome.pageAction['setPopup'] == undefined)\n\tlocalStorage['auto'] = false;\n\n/* we're going to get some nasty errors if our options are not set */\nvar options = ['options', 'sites', 'phrases', 'guess'];\nfor (var x = 0; x < options.length; x++) {\n\tif (localStorage[options[x]] == undefined)\n\t\tlocalStorage[options[x]] = '';\n}\n\n/* a function to refresh all the tab icons */\nfunction checkTab(tabId, url, change) {\n\tvar sites = localStorage['sites'].split(/,\\s+/);\n\tvar enabled = true;\n\tvar aurl = toHost(url);\n\tfor (var x = 0; x < sites.length; x++) {\n\t\tif (sites[x] != '' && sites[x] == aurl)\n\t\t\tenabled = false;\n\t}\n\n\tif (!change)\n\t\tchrome.tabs.sendRequest(tabId, enabled ? 'enabled' : 'disabled');\n\n\tif (enabled) {\n\t\tchrome.pageAction.setIcon({ path: 'images/icon48.png', tabId: tabId });\n\n\t\t/* check if we're using an older ver of Chrome, if so don't even mess with page actions */\n\t\tif (chrome.pageAction['setPopup'] != undefined)\n\t\t\tchrome.pageAction.setPopup({ popup: 'action/disable.html', tabId: tabId });\n\t}\n\telse {\n\t\tchrome.pageAction.setIcon({ path: 'images/icon48bw.png', tabId: tabId });\n\n\t\t/* check if we're using an older ver of Chrome, if so don't even mess with page actions */\n\t\tif (chrome.pageAction['setPopup'] != undefined)\n\t\t\tchrome.pageAction.setPopup({ popup: 'action/enable.html', tabId: tabId });\n\t}\n\n\tif (localStorage['button'] == 'true') {\n\t\tchrome.pageAction.show(tabId);\n\t}\n\telse {\n\t\tchrome.pageAction.hide(tabId);\n\t}\n\n\t/* show AtD will have nothing to do with these pages */\n\tif (aurl == 'http://acid3.acidtests.org' || aurl == 'https://chrome.google.com' || aurl == 'https://spreadsheets.google.com' || aurl == 'http://spreadsheets.google.com') {\n\t\tchrome.pageAction.hide(tabId);\n\t\tenabled = false;\n\t}\n}\n\nfunction refreshTabs() {\n\tchrome.windows.getAll({ populate: true }, function(windows) {\n\t\tfor (var x = 0; x < windows.length; x++) {\n\t\t\tvar window = windows[x];\n\t\t\tfor (var y = 0; y < window.tabs.length; y++) {\n\t\t\t\tcheckTab(window.tabs[y].id, window.tabs[y].url);\n\t\t\t}\n\t\t}\n\t});\n}\n\n/* setup code to show whether AtD is enabled/disabled on the current site */\nchrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {\n\tif (changeInfo.url) {\n\t\tcheckTab(tabId, changeInfo.url, true);\n\t}\n\telse {\n\t\tchrome.tabs.get(tabId, function(t) {\n\t\t\tcheckTab(tabId, t.url, true);\n\t\t});\n\t}\n});\n\n/* chrome message passing listener */\nchrome.extension.onRequest.addListener(function(request, sender, callback) {\n\tif (request.command == 'options') {\n\t\tcallback({ auto: localStorage['auto'], \n\t\t\t   options: localStorage['options'], \n\t\t\t   sites: localStorage['sites'],\n\t\t\t   phrases: localStorage['phrases'],\n\t\t\t   shortcut: localStorage['shortcut'] });\n\t\treturn;\n\t} \n\telse if (request.command == 'alert') {\n\t\tif (localStorage['message'] == 'true') {\n\t\t\talert(request.text);\n\t\t}\n\t\treturn;\n\t}\n\telse if (request.command == 'refreshTabs') {\n\t\trefreshTabs();\t\n\t\treturn;\t\t\n\t}\n\telse if (request.command == 'ignore') {\n\t\tvar strings = localStorage['phrases'].split(/,\\s*/);\n\t\tstrings.push(request.word);\n\t\tlocalStorage['phrases'] = strings.join(', ');\n\t\treturn;\n\t}\n\telse if (request.command == 'open') {\n\t\tvar left = (screen.width / 2) - (480 / 2);\n\t\tvar top = (screen.height / 2) - (380 / 2);\n\t\twindow.open( request.url, '', 'width=480,height=440,toolbar=0,status=0,resizable=0,location=0,menuBar=0,left=' + left + ',top=' + top).focus();\n\t\treturn;\n\t}\n\n\tvar xhr = new XMLHttpRequest();\n\n\tif (!xhr)\n\t\treturn null;\n\n\t/* handle language option */\n\t/*var language = localStorage['language'];\n\n\tif (language == 'French')\n\t\trequest.url = frenchServerUrl + request.url;\n\telse if (language == 'German')\n\t\trequest.url = germanServerUrl + request.url;\n\telse if (language == 'Portuguese')\n\t\trequest.url = spanishServerUrl + request.url;\n\telse if (language == 'Spanish')\n\t\trequest.url = spanishServerUrl + request.url;\n\telse\n\t\trequest.url = englishServerUrl + request.url;*/\n\t\t\n\t/* Only english works at this point */\n\trequest.url = 'https://afterthedeadline-pressgangccms.rhcloud.com' + request.url;\n\n\txhr.open('POST', request.url, true );\n                \n\txhr.onreadystatechange = function() {\n\t\tif ( xhr.readyState == 4 ) {\n\t\t\tcallback( xhr.responseText );\n\t\t}\n\t};\n\n\tif (localStorage['user-key'] == undefined)\n\t\tlocalStorage['user-key'] = 'atd-chrome-' + (new Date()).getTime();\n\n\tif (request.data.length)\n\t\trequest.data = encodeURI(request.data).replace(/&/g, '%26');\n                        \n\tif (request.data.length)\n\t\trequest.data +=  '&key=' + localStorage['user-key'];\n\telse\n\t\trequest.data = 'key=' + localStorage['user-key'];\n\n\t/* language guessing option */\n\tif (localStorage['guess'] == 'true')\n\t\trequest.data += '&guess=true';\n\n\txhr.setRequestHeader(\"Content-type\", \"application/x-www-form-urlencoded\");\n\txhr.send(\"data=\" + request.data);\n});\n\n/* if we have any tabs, lets set their icon to the right thing, right now */\nrefreshTabs();\n"]],"start1":0,"start2":0,"length1":0,"length2":6179}]],"length":6179}
